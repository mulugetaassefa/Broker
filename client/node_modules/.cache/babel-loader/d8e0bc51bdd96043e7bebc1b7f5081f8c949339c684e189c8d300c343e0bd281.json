{"ast":null,"code":"var _jsxFileName = \"D:\\\\project\\\\react\\\\project\\\\client\\\\src\\\\pages\\\\dashboard\\\\Messages.jsx\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useSocket } from '../../contexts/SocketContext';\nimport api from '../../services/api';\nimport { FiSend, FiPaperclip, FiImage, FiFile, FiSmile, FiChevronDown } from 'react-icons/fi';\nimport { format } from 'date-fns';\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst Messages = () => {\n  _s();\n  var _selectedConversation;\n  const {\n    user\n  } = useAuth();\n  const {\n    socket,\n    joinConversation,\n    leaveConversation,\n    sendMessage\n  } = useSocket();\n  const [message, setMessage] = useState('');\n  const [messages, setMessages] = useState([]);\n  const [conversations, setConversations] = useState([]);\n  const [selectedConversation, setSelectedConversation] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [isTyping, setIsTyping] = useState(false);\n  const messagesEndRef = useRef(null);\n  const fileInputRef = useRef(null);\n\n  // Fetch conversations on component mount\n  useEffect(() => {\n    const fetchConversations = async () => {\n      try {\n        setLoading(true);\n        const {\n          data\n        } = await api.messages.getConversations();\n        setConversations(data);\n        if (data.length > 0 && !selectedConversation) {\n          setSelectedConversation(data[0]);\n        }\n      } catch (err) {\n        setError('Failed to load conversations');\n        console.error('Error fetching conversations:', err);\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchConversations();\n  }, []);\n\n  // Fetch messages when selected conversation changes\n  useEffect(() => {\n    if (selectedConversation) {\n      const fetchMessages = async () => {\n        try {\n          setLoading(true);\n          const {\n            data\n          } = await api.messages.getMessages(selectedConversation._id);\n          setMessages(data);\n          scrollToBottom();\n        } catch (err) {\n          setError('Failed to load messages');\n          console.error('Error fetching messages:', err);\n        } finally {\n          setLoading(false);\n        }\n      };\n      fetchMessages();\n    }\n  }, [selectedConversation === null || selectedConversation === void 0 ? void 0 : selectedConversation._id]);\n\n  // Handle new messages from WebSocket\n  useEffect(() => {\n    if (!socket) return;\n    const handleNewMessage = newMessage => {\n      setMessages(prev => [...prev, newMessage]);\n      if (newMessage.sender._id !== user.id) {\n        markAsRead(newMessage._id);\n      }\n      scrollToBottom();\n    };\n    socket.on('new_message', handleNewMessage);\n    return () => {\n      socket.off('new_message', handleNewMessage);\n    };\n  }, [socket, user.id]);\n\n  // Join conversation room when selected\n  useEffect(() => {\n    if (selectedConversation !== null && selectedConversation !== void 0 && selectedConversation._id && socket) {\n      joinConversation(selectedConversation._id);\n      markMessagesAsRead();\n      return () => {\n        leaveConversation(selectedConversation._id);\n      };\n    }\n  }, [selectedConversation === null || selectedConversation === void 0 ? void 0 : selectedConversation._id, socket, joinConversation, leaveConversation]);\n  const scrollToBottom = useCallback(() => {\n    var _messagesEndRef$curre;\n    (_messagesEndRef$curre = messagesEndRef.current) === null || _messagesEndRef$curre === void 0 ? void 0 : _messagesEndRef$curre.scrollIntoView({\n      behavior: 'smooth'\n    });\n  }, []);\n  const handleSendMessage = async e => {\n    e.preventDefault();\n    if (!message.trim() || !selectedConversation) return;\n    try {\n      const newMessage = {\n        content: message,\n        conversationId: selectedConversation._id,\n        receiver: selectedConversation.participant._id\n      };\n\n      // Send message via WebSocket\n      await sendMessage(newMessage);\n\n      // Optimistic UI update\n      const optimisticMessage = {\n        ...newMessage,\n        _id: Date.now().toString(),\n        sender: {\n          _id: user.id,\n          firstName: user.firstName,\n          lastName: user.lastName\n        },\n        receiver: selectedConversation.participant._id,\n        createdAt: new Date().toISOString(),\n        isRead: false,\n        isOptimistic: true\n      };\n      setMessages(prev => [...prev, optimisticMessage]);\n      setMessage('');\n      scrollToBottom();\n\n      // Refresh conversations to update last message\n      const {\n        data\n      } = await api.messages.getConversations();\n      setConversations(data);\n    } catch (err) {\n      console.error('Error sending message:', err);\n      setError('Failed to send message');\n    }\n  };\n  const markAsRead = async messageId => {\n    try {\n      await api.messages.markAsRead(messageId);\n    } catch (error) {\n      console.error('Error marking message as read:', error);\n    }\n  };\n  const markMessagesAsRead = async () => {\n    const unreadMessages = messages.filter(msg => !msg.isRead && msg.receiver === user.id);\n    if (unreadMessages.length > 0) {\n      try {\n        await Promise.all(unreadMessages.map(msg => markAsRead(msg._id)));\n        // Update local state to reflect read status\n        setMessages(prev => prev.map(msg => ({\n          ...msg,\n          isRead: true\n        })));\n      } catch (error) {\n        console.error('Error marking messages as read:', error);\n      }\n    }\n  };\n  const handleFileUpload = e => {\n    const file = e.target.files[0];\n    if (!file) return;\n\n    // Handle file upload logic here\n    console.log('File selected:', file);\n    // You'll need to implement the actual file upload logic\n  };\n  const renderMessage = msg => {\n    var _msg$sender$firstName;\n    const isCurrentUser = msg.sender._id === user.id;\n    const messageDate = new Date(msg.createdAt);\n    const formattedTime = format(messageDate, 'h:mm a');\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`,\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `flex max-w-xs lg:max-w-md ${isCurrentUser ? 'flex-row-reverse' : ''}`,\n        children: [!isCurrentUser && /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center mr-2\",\n          children: (_msg$sender$firstName = msg.sender.firstName) === null || _msg$sender$firstName === void 0 ? void 0 : _msg$sender$firstName.charAt(0).toUpperCase()\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 188,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          children: [!isCurrentUser && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"text-xs text-gray-500 mb-1\",\n            children: [msg.sender.firstName, \" \", msg.sender.lastName]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 194,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `px-4 py-2 rounded-lg ${isCurrentUser ? 'bg-blue-500 text-white rounded-tr-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'}`,\n            children: [/*#__PURE__*/_jsxDEV(\"p\", {\n              className: \"break-words\",\n              children: msg.content\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 205,\n              columnNumber: 15\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"flex items-center justify-end mt-1\",\n              children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"text-xs opacity-75\",\n                children: formattedTime\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 207,\n                columnNumber: 17\n              }, this), isCurrentUser && /*#__PURE__*/_jsxDEV(\"span\", {\n                className: \"ml-1\",\n                children: msg.isRead ? '✓✓' : '✓'\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 211,\n                columnNumber: 19\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 206,\n              columnNumber: 15\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 198,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 192,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 186,\n        columnNumber: 9\n      }, this)\n    }, msg._id, false, {\n      fileName: _jsxFileName,\n      lineNumber: 182,\n      columnNumber: 7\n    }, this);\n  };\n  if (loading && !selectedConversation) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"flex items-center justify-center h-screen\",\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 226,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 225,\n      columnNumber: 7\n    }, this);\n  }\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"flex h-screen bg-gray-100\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"w-full md:w-1/3 lg:w-1/4 border-r border-gray-200 bg-white flex flex-col\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"p-4 border-b border-gray-200\",\n        children: /*#__PURE__*/_jsxDEV(\"h2\", {\n          className: \"text-xl font-semibold\",\n          children: \"Messages\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 236,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 235,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex-1 overflow-y-auto\",\n        children: conversations.length === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"p-4 text-center text-gray-500\",\n          children: \"No conversations yet\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 240,\n          columnNumber: 13\n        }, this) : conversations.map(conv => {\n          var _conv$participant$fir, _conv$lastMessage, _conv$lastMessage2;\n          return /*#__PURE__*/_jsxDEV(\"div\", {\n            className: `p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 flex items-center ${(selectedConversation === null || selectedConversation === void 0 ? void 0 : selectedConversation._id) === conv._id ? 'bg-blue-50' : ''}`,\n            onClick: () => setSelectedConversation(conv),\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"w-12 h-12 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center mr-3\",\n              children: (_conv$participant$fir = conv.participant.firstName) === null || _conv$participant$fir === void 0 ? void 0 : _conv$participant$fir.charAt(0).toUpperCase()\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 252,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"flex-1 min-w-0\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"flex justify-between items-center\",\n                children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n                  className: \"font-medium truncate\",\n                  children: [conv.participant.firstName, \" \", conv.participant.lastName]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 257,\n                  columnNumber: 21\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"text-xs text-gray-500\",\n                  children: (_conv$lastMessage = conv.lastMessage) !== null && _conv$lastMessage !== void 0 && _conv$lastMessage.createdAt ? format(new Date(conv.lastMessage.createdAt), 'MMM d') : ''\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 260,\n                  columnNumber: 21\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 256,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"flex justify-between items-center\",\n                children: [/*#__PURE__*/_jsxDEV(\"p\", {\n                  className: \"text-sm text-gray-500 truncate\",\n                  children: ((_conv$lastMessage2 = conv.lastMessage) === null || _conv$lastMessage2 === void 0 ? void 0 : _conv$lastMessage2.content) || 'No messages yet'\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 267,\n                  columnNumber: 21\n                }, this), conv.unreadCount > 0 && /*#__PURE__*/_jsxDEV(\"span\", {\n                  className: \"bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center ml-2\",\n                  children: conv.unreadCount\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 271,\n                  columnNumber: 23\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 266,\n                columnNumber: 19\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 255,\n              columnNumber: 17\n            }, this)]\n          }, conv._id, true, {\n            fileName: _jsxFileName,\n            lineNumber: 245,\n            columnNumber: 15\n          }, this);\n        })\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 238,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 234,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"hidden md:flex flex-col flex-1\",\n      children: selectedConversation ? /*#__PURE__*/_jsxDEV(_Fragment, {\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"p-4 border-b border-gray-200 bg-white flex items-center\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"w-10 h-10 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center mr-3\",\n            children: (_selectedConversation = selectedConversation.participant.firstName) === null || _selectedConversation === void 0 ? void 0 : _selectedConversation.charAt(0).toUpperCase()\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 289,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n              className: \"font-medium\",\n              children: [selectedConversation.participant.firstName, ' ', selectedConversation.participant.lastName]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 293,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n              className: \"text-xs text-gray-500\",\n              children: isTyping ? 'typing...' : 'Online'\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 297,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 292,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 288,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"flex-1 overflow-y-auto p-4 bg-gray-50\",\n          onClick: markMessagesAsRead,\n          children: messages.length === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"h-full flex items-center justify-center text-gray-500\",\n            children: \"No messages yet. Start the conversation!\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 309,\n            columnNumber: 17\n          }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"space-y-4\",\n            children: [messages.map(renderMessage), /*#__PURE__*/_jsxDEV(\"div\", {\n              ref: messagesEndRef\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 315,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 313,\n            columnNumber: 17\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 304,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"p-4 border-t border-gray-200 bg-white\",\n          children: /*#__PURE__*/_jsxDEV(\"form\", {\n            onSubmit: handleSendMessage,\n            className: \"flex items-center\",\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              type: \"button\",\n              className: \"p-2 text-gray-500 hover:text-gray-700\",\n              onClick: () => {\n                var _fileInputRef$current;\n                return (_fileInputRef$current = fileInputRef.current) === null || _fileInputRef$current === void 0 ? void 0 : _fileInputRef$current.click();\n              },\n              children: [/*#__PURE__*/_jsxDEV(FiPaperclip, {\n                className: \"h-5 w-5\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 328,\n                columnNumber: 19\n              }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n                type: \"file\",\n                ref: fileInputRef,\n                className: \"hidden\",\n                onChange: handleFileUpload\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 329,\n                columnNumber: 19\n              }, this)]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 323,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n              type: \"text\",\n              value: message,\n              onChange: e => setMessage(e.target.value),\n              placeholder: \"Type a message...\",\n              className: \"flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mx-2\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 336,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              type: \"submit\",\n              disabled: !message.trim(),\n              className: \"p-2 text-blue-500 hover:text-blue-700 disabled:text-gray-400\",\n              children: /*#__PURE__*/_jsxDEV(FiSend, {\n                className: \"h-5 w-5\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 348,\n                columnNumber: 19\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 343,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 322,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 321,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true) : /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex-1 flex items-center justify-center bg-gray-50\",\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"text-center p-6 max-w-md\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4\",\n            children: /*#__PURE__*/_jsxDEV(FiMessageSquare, {\n              className: \"h-8 w-8 text-blue-600\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 357,\n              columnNumber: 17\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 356,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"h3\", {\n            className: \"text-lg font-medium text-gray-900 mb-2\",\n            children: \"No conversation selected\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 359,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"text-gray-500\",\n            children: \"Select a conversation or start a new one to begin messaging.\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 360,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 355,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 354,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 284,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 232,\n    columnNumber: 5\n  }, this);\n};\n_s(Messages, \"4dIaT8m/WJh6JRhTVKX0vjKJolg=\", false, function () {\n  return [useAuth, useSocket];\n});\n_c = Messages;\nexport default Messages;\nvar _c;\n$RefreshReg$(_c, \"Messages\");","map":{"version":3,"names":["React","useState","useEffect","useRef","useCallback","useAuth","useSocket","api","FiSend","FiPaperclip","FiImage","FiFile","FiSmile","FiChevronDown","format","jsxDEV","_jsxDEV","Fragment","_Fragment","Messages","_s","_selectedConversation","user","socket","joinConversation","leaveConversation","sendMessage","message","setMessage","messages","setMessages","conversations","setConversations","selectedConversation","setSelectedConversation","loading","setLoading","error","setError","isTyping","setIsTyping","messagesEndRef","fileInputRef","fetchConversations","data","getConversations","length","err","console","fetchMessages","getMessages","_id","scrollToBottom","handleNewMessage","newMessage","prev","sender","id","markAsRead","on","off","markMessagesAsRead","_messagesEndRef$curre","current","scrollIntoView","behavior","handleSendMessage","e","preventDefault","trim","content","conversationId","receiver","participant","optimisticMessage","Date","now","toString","firstName","lastName","createdAt","toISOString","isRead","isOptimistic","messageId","unreadMessages","filter","msg","Promise","all","map","handleFileUpload","file","target","files","log","renderMessage","_msg$sender$firstName","isCurrentUser","messageDate","formattedTime","className","children","charAt","toUpperCase","fileName","_jsxFileName","lineNumber","columnNumber","conv","_conv$participant$fir","_conv$lastMessage","_conv$lastMessage2","onClick","lastMessage","unreadCount","ref","onSubmit","type","_fileInputRef$current","click","onChange","value","placeholder","disabled","FiMessageSquare","_c","$RefreshReg$"],"sources":["D:/project/react/project/client/src/pages/dashboard/Messages.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { useAuth } from '../../contexts/AuthContext';\r\nimport { useSocket } from '../../contexts/SocketContext';\r\nimport api from '../../services/api';\r\nimport { FiSend, FiPaperclip, FiImage, FiFile, FiSmile, FiChevronDown } from 'react-icons/fi';\r\nimport { format } from 'date-fns';\r\n\r\nconst Messages = () => {\r\n  const { user } = useAuth();\r\n  const { socket, joinConversation, leaveConversation, sendMessage } = useSocket();\r\n  const [message, setMessage] = useState('');\r\n  const [messages, setMessages] = useState([]);\r\n  const [conversations, setConversations] = useState([]);\r\n  const [selectedConversation, setSelectedConversation] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  const [isTyping, setIsTyping] = useState(false);\r\n  const messagesEndRef = useRef(null);\r\n  const fileInputRef = useRef(null);\r\n\r\n  // Fetch conversations on component mount\r\n  useEffect(() => {\r\n    const fetchConversations = async () => {\r\n      try {\r\n        setLoading(true);\r\n        const { data } = await api.messages.getConversations();\r\n        setConversations(data);\r\n        if (data.length > 0 && !selectedConversation) {\r\n          setSelectedConversation(data[0]);\r\n        }\r\n      } catch (err) {\r\n        setError('Failed to load conversations');\r\n        console.error('Error fetching conversations:', err);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchConversations();\r\n  }, []);\r\n\r\n  // Fetch messages when selected conversation changes\r\n  useEffect(() => {\r\n    if (selectedConversation) {\r\n      const fetchMessages = async () => {\r\n        try {\r\n          setLoading(true);\r\n          const { data } = await api.messages.getMessages(selectedConversation._id);\r\n          setMessages(data);\r\n          scrollToBottom();\r\n        } catch (err) {\r\n          setError('Failed to load messages');\r\n          console.error('Error fetching messages:', err);\r\n        } finally {\r\n          setLoading(false);\r\n        }\r\n      };\r\n\r\n      fetchMessages();\r\n    }\r\n  }, [selectedConversation?._id]);\r\n\r\n  // Handle new messages from WebSocket\r\n  useEffect(() => {\r\n    if (!socket) return;\r\n\r\n    const handleNewMessage = (newMessage) => {\r\n      setMessages(prev => [...prev, newMessage]);\r\n      if (newMessage.sender._id !== user.id) {\r\n        markAsRead(newMessage._id);\r\n      }\r\n      scrollToBottom();\r\n    };\r\n\r\n    socket.on('new_message', handleNewMessage);\r\n    return () => {\r\n      socket.off('new_message', handleNewMessage);\r\n    };\r\n  }, [socket, user.id]);\r\n\r\n  // Join conversation room when selected\r\n  useEffect(() => {\r\n    if (selectedConversation?._id && socket) {\r\n      joinConversation(selectedConversation._id);\r\n      markMessagesAsRead();\r\n      \r\n      return () => {\r\n        leaveConversation(selectedConversation._id);\r\n      };\r\n    }\r\n  }, [selectedConversation?._id, socket, joinConversation, leaveConversation]);\r\n\r\n  const scrollToBottom = useCallback(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  }, []);\r\n\r\n  const handleSendMessage = async (e) => {\r\n    e.preventDefault();\r\n    if (!message.trim() || !selectedConversation) return;\r\n\r\n    try {\r\n      const newMessage = {\r\n        content: message,\r\n        conversationId: selectedConversation._id,\r\n        receiver: selectedConversation.participant._id\r\n      };\r\n\r\n      // Send message via WebSocket\r\n      await sendMessage(newMessage);\r\n      \r\n      // Optimistic UI update\r\n      const optimisticMessage = {\r\n        ...newMessage,\r\n        _id: Date.now().toString(),\r\n        sender: { _id: user.id, firstName: user.firstName, lastName: user.lastName },\r\n        receiver: selectedConversation.participant._id,\r\n        createdAt: new Date().toISOString(),\r\n        isRead: false,\r\n        isOptimistic: true\r\n      };\r\n      \r\n      setMessages(prev => [...prev, optimisticMessage]);\r\n      setMessage('');\r\n      scrollToBottom();\r\n      \r\n      // Refresh conversations to update last message\r\n      const { data } = await api.messages.getConversations();\r\n      setConversations(data);\r\n      \r\n    } catch (err) {\r\n      console.error('Error sending message:', err);\r\n      setError('Failed to send message');\r\n    }\r\n  };\r\n\r\n  const markAsRead = async (messageId) => {\r\n    try {\r\n      await api.messages.markAsRead(messageId);\r\n    } catch (error) {\r\n      console.error('Error marking message as read:', error);\r\n    }\r\n  };\r\n\r\n  const markMessagesAsRead = async () => {\r\n    const unreadMessages = messages.filter(\r\n      msg => !msg.isRead && msg.receiver === user.id\r\n    );\r\n    \r\n    if (unreadMessages.length > 0) {\r\n      try {\r\n        await Promise.all(\r\n          unreadMessages.map(msg => markAsRead(msg._id))\r\n        );\r\n        // Update local state to reflect read status\r\n        setMessages(prev => \r\n          prev.map(msg => ({\r\n            ...msg,\r\n            isRead: true\r\n          }))\r\n        );\r\n      } catch (error) {\r\n        console.error('Error marking messages as read:', error);\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleFileUpload = (e) => {\r\n    const file = e.target.files[0];\r\n    if (!file) return;\r\n\r\n    // Handle file upload logic here\r\n    console.log('File selected:', file);\r\n    // You'll need to implement the actual file upload logic\r\n  };\r\n\r\n  const renderMessage = (msg) => {\r\n    const isCurrentUser = msg.sender._id === user.id;\r\n    const messageDate = new Date(msg.createdAt);\r\n    const formattedTime = format(messageDate, 'h:mm a');\r\n\r\n    return (\r\n      <div \r\n        key={msg._id} \r\n        className={`flex ${isCurrentUser ? 'justify-end' : 'justify-start'} mb-4`}\r\n      >\r\n        <div className={`flex max-w-xs lg:max-w-md ${isCurrentUser ? 'flex-row-reverse' : ''}`}>\r\n          {!isCurrentUser && (\r\n            <div className=\"w-8 h-8 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center mr-2\">\r\n              {msg.sender.firstName?.charAt(0).toUpperCase()}\r\n            </div>\r\n          )}\r\n          <div>\r\n            {!isCurrentUser && (\r\n              <div className=\"text-xs text-gray-500 mb-1\">\r\n                {msg.sender.firstName} {msg.sender.lastName}\r\n              </div>\r\n            )}\r\n            <div\r\n              className={`px-4 py-2 rounded-lg ${\r\n                isCurrentUser\r\n                  ? 'bg-blue-500 text-white rounded-tr-none'\r\n                  : 'bg-gray-200 text-gray-800 rounded-tl-none'\r\n              }`}\r\n            >\r\n              <p className=\"break-words\">{msg.content}</p>\r\n              <div className=\"flex items-center justify-end mt-1\">\r\n                <span className=\"text-xs opacity-75\">\r\n                  {formattedTime}\r\n                </span>\r\n                {isCurrentUser && (\r\n                  <span className=\"ml-1\">\r\n                    {msg.isRead ? '✓✓' : '✓'}\r\n                  </span>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  if (loading && !selectedConversation) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-screen\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500\"></div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex h-screen bg-gray-100\">\r\n      {/* Sidebar with conversations */}\r\n      <div className=\"w-full md:w-1/3 lg:w-1/4 border-r border-gray-200 bg-white flex flex-col\">\r\n        <div className=\"p-4 border-b border-gray-200\">\r\n          <h2 className=\"text-xl font-semibold\">Messages</h2>\r\n        </div>\r\n        <div className=\"flex-1 overflow-y-auto\">\r\n          {conversations.length === 0 ? (\r\n            <div className=\"p-4 text-center text-gray-500\">\r\n              No conversations yet\r\n            </div>\r\n          ) : (\r\n            conversations.map((conv) => (\r\n              <div\r\n                key={conv._id}\r\n                className={`p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 flex items-center ${\r\n                  selectedConversation?._id === conv._id ? 'bg-blue-50' : ''\r\n                }`}\r\n                onClick={() => setSelectedConversation(conv)}\r\n              >\r\n                <div className=\"w-12 h-12 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center mr-3\">\r\n                  {conv.participant.firstName?.charAt(0).toUpperCase()}\r\n                </div>\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <div className=\"flex justify-between items-center\">\r\n                    <h3 className=\"font-medium truncate\">\r\n                      {conv.participant.firstName} {conv.participant.lastName}\r\n                    </h3>\r\n                    <span className=\"text-xs text-gray-500\">\r\n                      {conv.lastMessage?.createdAt \r\n                        ? format(new Date(conv.lastMessage.createdAt), 'MMM d')\r\n                        : ''}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"flex justify-between items-center\">\r\n                    <p className=\"text-sm text-gray-500 truncate\">\r\n                      {conv.lastMessage?.content || 'No messages yet'}\r\n                    </p>\r\n                    {conv.unreadCount > 0 && (\r\n                      <span className=\"bg-blue-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center ml-2\">\r\n                        {conv.unreadCount}\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Chat area */}\r\n      <div className=\"hidden md:flex flex-col flex-1\">\r\n        {selectedConversation ? (\r\n          <>\r\n            {/* Chat header */}\r\n            <div className=\"p-4 border-b border-gray-200 bg-white flex items-center\">\r\n              <div className=\"w-10 h-10 rounded-full bg-gray-300 flex-shrink-0 flex items-center justify-center mr-3\">\r\n                {selectedConversation.participant.firstName?.charAt(0).toUpperCase()}\r\n              </div>\r\n              <div>\r\n                <h2 className=\"font-medium\">\r\n                  {selectedConversation.participant.firstName}{' '}\r\n                  {selectedConversation.participant.lastName}\r\n                </h2>\r\n                <p className=\"text-xs text-gray-500\">\r\n                  {isTyping ? 'typing...' : 'Online'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Messages */}\r\n            <div \r\n              className=\"flex-1 overflow-y-auto p-4 bg-gray-50\"\r\n              onClick={markMessagesAsRead}\r\n            >\r\n              {messages.length === 0 ? (\r\n                <div className=\"h-full flex items-center justify-center text-gray-500\">\r\n                  No messages yet. Start the conversation!\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-4\">\r\n                  {messages.map(renderMessage)}\r\n                  <div ref={messagesEndRef} />\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Message input */}\r\n            <div className=\"p-4 border-t border-gray-200 bg-white\">\r\n              <form onSubmit={handleSendMessage} className=\"flex items-center\">\r\n                <button\r\n                  type=\"button\"\r\n                  className=\"p-2 text-gray-500 hover:text-gray-700\"\r\n                  onClick={() => fileInputRef.current?.click()}\r\n                >\r\n                  <FiPaperclip className=\"h-5 w-5\" />\r\n                  <input\r\n                    type=\"file\"\r\n                    ref={fileInputRef}\r\n                    className=\"hidden\"\r\n                    onChange={handleFileUpload}\r\n                  />\r\n                </button>\r\n                <input\r\n                  type=\"text\"\r\n                  value={message}\r\n                  onChange={(e) => setMessage(e.target.value)}\r\n                  placeholder=\"Type a message...\"\r\n                  className=\"flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mx-2\"\r\n                />\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={!message.trim()}\r\n                  className=\"p-2 text-blue-500 hover:text-blue-700 disabled:text-gray-400\"\r\n                >\r\n                  <FiSend className=\"h-5 w-5\" />\r\n                </button>\r\n              </form>\r\n            </div>\r\n          </>\r\n        ) : (\r\n          <div className=\"flex-1 flex items-center justify-center bg-gray-50\">\r\n            <div className=\"text-center p-6 max-w-md\">\r\n              <div className=\"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4\">\r\n                <FiMessageSquare className=\"h-8 w-8 text-blue-600\" />\r\n              </div>\r\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No conversation selected</h3>\r\n              <p className=\"text-gray-500\">\r\n                Select a conversation or start a new one to begin messaging.\r\n              </p>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Messages;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}